<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Users ‚Äì Palette and Fit Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Style+Script&display=swap" rel="stylesheet">

  <style>
    :root {
      --sidebar-bg: #ffffff;
      --sidebar-dark: #23242a;
      --main-bg: #f9f5ff;
      --main-dark: #18181b;
      --accent: #ad00e2;
      --accent2: #c2a1ff;
      --text: #23242a;
      --card-bg: #ffffff;
      --card-dark: #23223c;
      --border-radius: 1.1rem;
      --shadow: 0 4px 24px #e4ddff, 0 1.5px 10px #d4c6ff80;
      --shadow-dark: 0 6px 32px #0004, 0 1.5px 8px #0003;
      --sidebar-width: 235px;
    }

    body.dark-mode {
      --sidebar-bg: #23242a;
      --main-bg: #09090b;
      --card-bg: #23223c;
      --text: #fdfcff;
      --shadow: 0 6px 32px #0005, 0 1.5px 8px #0003;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--main-bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    .admin-root {
      display: flex;
      min-height: 100vh;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      min-height: 100vh;
      background: var(--sidebar-bg);
      padding: 2rem 0.7rem 2.2rem 0.7rem;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #ececec;
      z-index: 100;
      overflow-y: auto;
      box-sizing: border-box;
    }

    .sidebar .logo {
      font-family: "Style Script", cursive;
      color: #ad00e2;
      font-size: 2.4rem;
      font-weight: 700;
      letter-spacing: 2px;
      margin-bottom: 0.4em;
      text-shadow: none;
      text-align: left;
      user-select: none;
      white-space: nowrap;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .sidebar-nav a {
      color: var(--accent);
      text-decoration: none;
      font-size: 1.06rem;
      font-weight: 600;
      padding: 0.62rem 1.2rem;
      border-radius: 0.75rem;
      transition: background 0.18s, color 0.18s, transform 0.12s;
      letter-spacing: 0.2px;
      cursor: pointer;
    }

    .sidebar-nav a.active,
    .sidebar-nav a:hover {
      background: linear-gradient(90deg, #ad00e2 55%, #c2a1ff 100%);
      color: #fff !important;
      font-weight: 700;
      transform: translateY(-1px);
    }

    .sidebar-bottom {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      align-items: stretch;
    }

    .darkmode-btn,
    .logout-btn {
      width: 100%;
      box-sizing: border-box;
      padding: 0.85rem 0;
      font-size: 0.98rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #ad00e2 75%, #c2a1ff 100%);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 12px #ad00e229;
      transition: background 0.18s, color 0.18s, transform 0.12s;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    .darkmode-btn:hover,
    .logout-btn:hover {
      background: linear-gradient(90deg, #c2a1ff 10%, #ad00e2 90%);
      color: #fff;
      transform: translateY(-1px);
    }

    /* ===== Main panel ===== */
    .main-panel {
      margin-left: var(--sidebar-width);
      flex: 1;
      padding: 2.4rem 2.1rem 1.7rem 2.1rem;
      background: var(--main-bg);
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      transition: background 0.3s, margin-left 0.3s;
    }

    /* ===== Users table ===== */
    .users-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.8rem;
    }

    .users-header h2 {
      color: var(--accent);
      font-size: 1.8rem;
      margin: 0;
      letter-spacing: 0.04em;
      font-weight: 800;
    }

    #searchUser {
      padding: 0.55em 1em;
      border-radius: 9px;
      border: 1.4px solid #d0c2ff;
      font-size: 0.96rem;
      background: #fff;
      min-width: 190px;
      box-shadow: 0 1px 9px #00000010;
      outline: none;
      transition: border 0.18s, box-shadow 0.18s;
    }

    #searchUser:focus {
      border-color: #ad00e2;
      box-shadow: 0 0 0 1px #e1d3ff;
    }

    .users-table-wrap {
      background: var(--card-bg);
      border-radius: 1.1rem;
      padding: 1.2rem 0.8rem 1rem 0.8rem;
      box-shadow: var(--shadow);
      border: 2px solid #ece6ff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.96rem;
      background: var(--card-bg);
    }

    th, td {
      padding: 0.58em 0.8em;
      text-align: left;
    }

    th {
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.06em;
      font-size: 0.82rem;
      text-transform: uppercase;
      border-bottom: 2px solid #9230ca;
    }

    tbody tr:nth-child(even) { background: #f8f5ff; }
    tbody tr:hover { background: #f3ecfa; }

    .delete-user,
    .view-chat-btn {
      border-radius: 999px;
      padding: 0.32em 1em;
      font-size: 0.86rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.16s, transform 0.12s, box-shadow 0.16s;
      outline: none;
      white-space: nowrap;
    }

    .delete-user {
      background: linear-gradient(90deg, #ff3355 70%, #fa72c4 100%);
      color: #fff;
      box-shadow: 0 2px 8px #ff338433;
      margin-right: 0.35rem;
    }

    .delete-user:hover {
      background: linear-gradient(90deg, #ad00e2 65%, #ff3355 100%);
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 8px 18px #a300e51f;
    }

    .view-chat-btn {
      background: #fff;
      color: #6b3bb0;
      border: 1px solid #c9b5ff;
      box-shadow: 0 1px 6px #00000015;
    }

    .view-chat-btn:hover {
      background: #f5eeff;
      transform: translateY(-1px);
    }

    .view-chat-btn.disabled {
      opacity: 0.6;
      cursor: default;
      background: #f3f3f3;
      color: #aaaaaa;
      border-color: #e0e0e0;
      box-shadow: none;
    }

    .deleting {
      opacity: 0;
      transform: translateX(40px) scale(0.97);
      transition: opacity 0.38s cubic-bezier(.6,.5,.55,1), transform 0.38s cubic-bezier(.6,.5,.55,1);
    }

    /* ===== Messages table (history) ===== */
    .msg-header {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--accent);
      margin-top: 0.6rem;
      margin-bottom: 0.4rem;
      letter-spacing: 0.03em;
    }

    .msg-table-wrap {
      background: var(--card-bg);
      border-radius: 1.1rem;
      padding: 1.1rem 0.8rem 1rem 0.8rem;
      box-shadow: var(--shadow);
      border: 2px solid #ece6ff;
      margin-bottom: 2.2rem;
    }

    .bot-reply {
      max-height: 4.5em;
      overflow: hidden;
      position: relative;
      line-height: 1.5em;
      transition: max-height 0.26s cubic-bezier(.53,.1,.52,1.2);
      white-space: pre-line;
      word-break: break-word;
      font-size: 0.94rem;
    }

    .bot-reply.expanded {
      max-height: 900em !important;
    }

    .read-more-btn {
      display: inline-block;
      margin-left: 0.3em;
      color: var(--accent2);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.86rem;
      user-select: none;
      text-decoration: underline;
    }

    .user-question {
      white-space: pre-line;
      word-break: break-word;
      font-size: 0.94rem;
    }

    /* ===== Confirm modal ===== */
    #confirmModal {
      position: fixed;
      z-index: 9999;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #confirmModal.active {
      display: flex;
    }

    .modal-overlay {
      position: absolute;
      inset: 0;
      background: rgba(30, 10, 40, 0.34);
      z-index: 1;
    }

    .modal-box {
      position: relative;
      z-index: 2;
      background: #fff;
      color: #333;
      border-radius: 1.2em;
      box-shadow: 0 4px 48px #ad00e266, 0 0px 1.5px #ad00e208;
      width: 96vw;
      max-width: 370px;
      padding: 2.1em 2em 1.3em 2em;
      text-align: center;
      animation: modalpop 0.24s cubic-bezier(.44,.87,.68,1.01);
    }

    @keyframes modalpop {
      from { transform: scale(0.88) translateY(70px); opacity: 0; }
      to   { transform: scale(1) translateY(0); opacity: 1; }
    }

    .modal-title {
      font-size: 1.35em;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.6em;
      letter-spacing: 0.4px;
    }

    .modal-msg {
      color: #444;
      margin-bottom: 1.6em;
      font-size: 1.02em;
      font-weight: 500;
    }

    .modal-actions {
      display: flex;
      gap: 1em;
      justify-content: center;
    }

    .modal-btn {
      font-size: 1.02em;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 0.65em 1.5em;
      cursor: pointer;
      transition: background 0.16s, color 0.16s;
      min-width: 82px;
    }

    .modal-btn.cancel {
      background: #e7e7e7;
      color: #6b4b88;
    }

    .modal-btn.ok {
      background: linear-gradient(90deg, #ad00e2 75%, #c2a1ff 100%);
      color: #fff;
      box-shadow: 0 3px 10px #ad00e233;
    }

    .modal-btn.ok:hover {
      background: linear-gradient(90deg, #910dc8 60%, #8e53f7 100%);
    }

    .modal-btn.cancel:hover {
      background: #eaeaea;
    }

    /* ===== Logout modal ===== */
    .logout-modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(36, 0, 42, 0.24);
      z-index: 9000;
      justify-content: center;
      align-items: center;
    }

    .logout-modal-bg.active { display: flex !important; }

    .logout-modal-box {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 8px 42px #ad00e299, 0 0 0 2px #ad00e241;
      min-width: 320px;
      max-width: 94vw;
      padding: 2.1rem 2.1rem 1.4rem 2.1rem;
      text-align: center;
      animation: popin 0.28s;
    }

    @keyframes popin {
      from { transform: translateY(30px) scale(0.97); opacity: 0.1; }
      to   { transform: none; opacity: 1; }
    }

    .logout-title {
      font-size: 1.53rem;
      font-weight: 700;
      color: #ad00e2;
      margin-bottom: 0.4em;
    }

    .logout-desc {
      font-size: 1.07rem;
      color: #6d217c;
      margin-bottom: 2.1em;
    }

    .logout-modal-btn {
      background: linear-gradient(90deg, #ad00e2 75%, #c2a1ff 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.05rem;
      padding: 0.7em 2.9em;
      box-shadow: 0 2px 18px #ad00e233;
      cursor: pointer;
      transition: background 0.17s;
    }

    .logout-modal-btn:hover {
      background: linear-gradient(90deg, #c2a1ff 15%, #ad00e2 90%);
    }

    /* ===== Dark mode overrides ===== */
    body.dark-mode .sidebar {
      background: var(--sidebar-dark);
      border-right: 2px solid #3d3750;
    }

    body.dark-mode .sidebar-nav a {
      color: #fff;
    }

    body.dark-mode .sidebar-nav a.active,
    body.dark-mode .sidebar-nav a:hover {
      background: linear-gradient(90deg, #ad00e2 55%, #c2a1ff 100%);
      color: #fff !important;
    }

    body.dark-mode .users-table-wrap,
    body.dark-mode .msg-table-wrap {
      background: var(--card-dark);
      color: #fff;
      border-color: #2e2b40;
      box-shadow: var(--shadow-dark);
    }

    body.dark-mode th {
      background: var(--accent2);
    }

    body.dark-mode tbody tr:nth-child(even) { background: #23223c; }
    body.dark-mode tbody tr:hover { background: #2a2754; }

    body.dark-mode .modal-box {
      background: #201629;
      color: #fff;
    }

    body.dark-mode .modal-title { color: var(--accent2); }
    body.dark-mode .modal-msg { color: #e1d9ef; }
    body.dark-mode .modal-btn.cancel {
      background: #36295c;
      color: #dccfff;
    }
    body.dark-mode .modal-btn.cancel:hover { background: #2b233b; }

    body.dark-mode .bot-reply,
    body.dark-mode .user-question {
      color: #f4ecff;
    }

    /* ===== Responsive ===== */
    @media (max-width: 800px) {
      .main-panel {
        padding: 1.4rem 0.6rem 1rem 0.6rem;
      }
      .users-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 700px) {
      .sidebar {
        position: static;
        width: 100vw;
        height: auto;
        min-height: 0;
        border-right: none;
        border-bottom: 2px solid #ececec;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 0.8rem;
        padding: 0.7rem 0.7rem 0.7rem 1rem;
      }

      .sidebar .logo {
        font-size: 1.25rem;
        margin-bottom: 0;
      }

      .sidebar-bottom {
        margin-top: 0;
        flex-direction: row;
        gap: 0.4rem;
      }

      .darkmode-btn,
      .logout-btn {
        padding-inline: 0.8rem;
        font-size: 0.8rem;
      }

      .main-panel {
        margin-left: 0 !important;
      }

      table, th, td {
        font-size: 0.86rem;
      }
    }

    @media (max-width: 600px) {
      th, td {
        padding: 0.4em 0.5em;
      }
      .logout-modal-box {
        min-width: 0;
        padding: 1.1rem 0.4rem 1rem 0.4rem;
      }
    }
  </style>
</head>
<body>
  <div class="admin-root">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">Palette and Fit</div>
      <nav class="sidebar-nav">
        <a href="adminpanel.html">Dashboard</a>
        <a href="adminpanelproducts.html">Products</a>
        <a href="adminpaneluser.html" class="active">Users</a>
      </nav>
      <div class="sidebar-bottom">
        <button class="darkmode-btn" id="darkModeToggle">
          <span style="font-size:1.18em;">üåô</span>
          <span>Dark Mode</span>
        </button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main-panel">
      <div class="users-header">
        <h2>Users</h2>
        <input id="searchUser" type="text" placeholder="Search user by name or email...">
      </div>

      <div class="users-table-wrap">
        <table id="users-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Gender</th>
              <th>Age</th>
              <th>Skin Tone</th>
              <th>Date Joined</th>
              <th style="min-width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <!-- Users rendered here -->
          </tbody>
        </table>
      </div>

      <!-- Chat History Section (summary for all users) -->
      <div class="msg-header">Recent User Messages & Bot Replies</div>
      <div class="msg-table-wrap">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Question</th>
              <th>Bot Reply</th>
              <th>Date/Time</th>
            </tr>
          </thead>
          <tbody id="msg-tbody">
            <!-- Messages rendered here -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Delete confirm modal -->
  <div id="confirmModal">
    <div class="modal-overlay"></div>
    <div class="modal-box">
      <div class="modal-title">Delete user?</div>
      <div class="modal-msg">Are you sure you want to delete this user?</div>
      <div class="modal-actions">
        <button id="modalCancel" class="modal-btn cancel">Cancel</button>
        <button id="modalOK" class="modal-btn ok">Delete</button>
      </div>
    </div>
  </div>

  <!-- Logout modal -->
  <div id="logoutModal" class="logout-modal-bg">
    <div class="logout-modal-box">
      <div class="logout-title">Logged out!</div>
      <div class="logout-desc">You have been successfully logged out.</div>
      <button class="logout-modal-btn" id="logoutModalOk">OK</button>
    </div>
  </div>

  <script>
    // ========= API base (local vs deployed) =========
    const API_BASE =
      (window.location.hostname === "127.0.0.1" ||
       window.location.hostname === "localhost")
        ? "http://127.0.0.1:5001"
        : "https://palette-and-fit-backend.onrender.com";

    // üîê Admin secret (same as backend .env)
    const ADMIN_SECRET = "palfit_admin_2025_supersecret";

    // ========= Simple admin guard =========
    (function guardAdminUsers() {
      const email = localStorage.getItem("userEmail");
      const isAdmin = localStorage.getItem("isAdmin") === "true";
      if (!email || !isAdmin) {
        window.location.href = "login.html";
      }
    })();

    // ========= Dark mode =========
    const darkBtn = document.getElementById("darkModeToggle");
    const bodyEl = document.body;

    function setDarkBtn(isDark) {
      darkBtn.innerHTML = isDark
        ? '<span style="font-size:1.18em;">‚òÄÔ∏è</span><span>Light Mode</span>'
        : '<span style="font-size:1.18em;">üåô</span><span>Dark Mode</span>';
    }

    if (localStorage.getItem("darkMode") === "true") {
      bodyEl.classList.add("dark-mode");
      setDarkBtn(true);
    } else {
      setDarkBtn(false);
    }

    darkBtn.addEventListener("click", () => {
      const isDark = bodyEl.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", isDark);
      setDarkBtn(isDark);
    });

    // ========= Logout flow =========
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutModal = document.getElementById("logoutModal");
    const logoutModalOk = document.getElementById("logoutModalOk");

    function performLogout() {
      localStorage.removeItem("userEmail");
      localStorage.removeItem("isAdmin");
      localStorage.removeItem("isLoggedIn");
      window.location.href = "login.html";
    }

    logoutBtn.addEventListener("click", () => {
      logoutModal.classList.add("active");
    });

    logoutModalOk.addEventListener("click", () => {
      logoutModal.classList.remove("active");
      performLogout();
    });

    // ========= Global data =========
    let users = [];
    let messages = [];
    let userIdToDelete = null;
    let trToDelete = null;
    let chatUsersSet = new Set(); // jinke paas messages hain

    const searchInput = document.getElementById("searchUser");
    const usersTbody = document.getElementById("users-tbody");
    const msgTbody = document.getElementById("msg-tbody");

    // ========= Fetch users =========
    async function fetchUsers() {
      try {
        const res = await fetch(`${API_BASE}/api/users`, {
          headers: { "X-Admin-Secret": ADMIN_SECRET }
        });
        if (!res.ok) throw new Error("Failed to fetch users");
        users = await res.json();
        renderUsersTable(searchInput.value);
      } catch (err) {
        console.error(err);
        alert("Error fetching users from server.");
      }
    }

    // ========= Fetch messages =========
    async function fetchMessages() {
      try {
        const res = await fetch(`${API_BASE}/api/messages`, {
          headers: { "X-Admin-Secret": ADMIN_SECRET }
        });
        if (!res.ok) throw new Error("Failed to fetch messages");
        messages = await res.json();

        // Build user-set jinke paas chat hai
        chatUsersSet = new Set(
          (messages || [])
            .map(m => (m.user || "").toLowerCase())
            .filter(Boolean)
        );

        renderUsersTable(searchInput.value); // taake "View Chats" button sahi dikhe
        renderMsgTable();
      } catch (err) {
        console.error(err);
        alert("Error fetching messages from server.");
      }
    }

    // ========= Render users table =========
    function renderUsersTable(filterText = "") {
      usersTbody.innerHTML = "";
      const f = (filterText || "").toLowerCase();

      users
        .filter(u =>
          (u.name || "").toLowerCase().includes(f) ||
          (u.email || "").toLowerCase().includes(f)
        )
        .forEach(u => {
          const hasChat = chatUsersSet.has((u.email || "").toLowerCase());
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${u.name || ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.gender || ""}</td>
            <td>${u.age || ""}</td>
            <td>${u.skintone || ""}</td>
            <td>${u.joined || ""}</td>
            <td>
              <button class="delete-user" data-id="${u.id}">Delete</button>
              ${
                hasChat
                  ? `<button class="view-chat-btn" data-email="${u.email}">View Chats</button>`
                  : `<button class="view-chat-btn disabled" disabled>No Chats</button>`
              }
            </td>
          `;

          usersTbody.appendChild(tr);
        });

      // Attach delete events
      document.querySelectorAll(".delete-user").forEach(btn => {
        btn.onclick = function () {
          userIdToDelete = btn.dataset.id;
          trToDelete = btn.closest("tr");
          showConfirmModal();
        };
      });

      // Attach "View Chats" events
      document.querySelectorAll(".view-chat-btn").forEach(btn => {
        if (btn.classList.contains("disabled")) return;
        btn.onclick = function () {
          const email = btn.dataset.email;
          if (!email) return;
          // slug: userchat.html?user=<email>
          const url = `userchat.html?user=${encodeURIComponent(email)}`;
          window.location.href = url;
        };
      });
    }

    // ========= Confirm modal =========
    const confirmModal = document.getElementById("confirmModal");
    const modalCancel = document.getElementById("modalCancel");
    const modalOK = document.getElementById("modalOK");

    function showConfirmModal() {
      confirmModal.classList.add("active");
    }

    function hideConfirmModal() {
      confirmModal.classList.remove("active");
    }

    modalCancel.onclick = function () {
      userIdToDelete = null;
      trToDelete = null;
      hideConfirmModal();
    };

    modalOK.onclick = async function () {
      hideConfirmModal();
      if (userIdToDelete && trToDelete) {
        trToDelete.classList.add("deleting");
        setTimeout(async () => {
          try {
            const res = await fetch(`${API_BASE}/api/users/${userIdToDelete}`, {
              method: "DELETE",
              headers: { "X-Admin-Secret": ADMIN_SECRET }
            });
            if (!res.ok) throw new Error("Failed to delete user");
            users = users.filter(u => String(u.id) !== String(userIdToDelete));
            renderUsersTable(searchInput.value);
          } catch (err) {
            trToDelete.classList.remove("deleting");
            alert("Error deleting user on server.");
          } finally {
            userIdToDelete = null;
            trToDelete = null;
          }
        }, 380);
      }
    };

    // ========= Search =========
    searchInput.addEventListener("input", function () {
      renderUsersTable(this.value);
    });

    // ========= Render message summary table =========
    function renderMsgTable() {
      msgTbody.innerHTML = "";
      (messages || []).forEach((msg, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${msg.user || ""}</td>
          <td class="user-question">${msg.question || ""}</td>
          <td>
            <div class="bot-reply" id="bot-reply-${idx}">${msg.reply || ""}</div>
          </td>
          <td style="font-size:0.87rem;color:#777;">${msg.date || ""}</td>
        `;
        msgTbody.appendChild(tr);
      });

      // Add Read more / Show less
      setTimeout(() => {
        document.querySelectorAll(".bot-reply").forEach(function (replyDiv) {
          // Measure overflow
          replyDiv.classList.remove("expanded");
          replyDiv.style.maxHeight = "none";
          const fullHeight = replyDiv.scrollHeight;
          replyDiv.style.maxHeight = "4.5em";
          const limitedHeight = replyDiv.clientHeight;

          // Remove old button if any
          const prevBtn = replyDiv.parentElement.querySelector(".read-more-btn");
          if (prevBtn) prevBtn.remove();

          if (fullHeight > limitedHeight + 2) {
            replyDiv.classList.remove("expanded");
            replyDiv.style.maxHeight = "4.5em";
            replyDiv.style.overflow = "hidden";

            const btn = document.createElement("span");
            btn.textContent = "Read more";
            btn.className = "read-more-btn";
            btn.onclick = function () {
              if (replyDiv.classList.contains("expanded")) {
                replyDiv.classList.remove("expanded");
                replyDiv.style.maxHeight = "4.5em";
                btn.textContent = "Read more";
              } else {
                replyDiv.classList.add("expanded");
                replyDiv.style.maxHeight = "900em";
                btn.textContent = "Show less";
              }
            };
            replyDiv.parentElement.appendChild(btn);
          } else {
            replyDiv.classList.remove("expanded");
            replyDiv.style.maxHeight = "none";
          }
        });
      }, 80);
    }

    // ========= Initial load =========
    document.addEventListener("DOMContentLoaded", () => {
      fetchUsers();
      fetchMessages();
    });
  </script>
</body>
</html>
